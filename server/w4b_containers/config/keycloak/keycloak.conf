# /server/w4b_containers/config/keycloak/keycloak.conf

# Server
hostname=auth.we4bee.network
http-enabled=true
https-enabled=false  # Fix: Disable HTTPS (will be handled by reverse proxy)
proxy=edge

# Database
db=postgres
db-url-host=hive_postgres_keycloak
db-url-port=33434
db-url-database=keycloak
db-url=jdbc:postgresql://hive_postgres_keycloak:33434/keycloak
db-username=${KC_DB_USERNAME}
db-password=${KC_DB_PASSWORD}
db-pool-initial-size=1
db-pool-min-size=2
db-pool-max-size=5

# Features & Cache
features=token-exchange,admin-fine-grained-authz,authorization
features-disabled=account2,dynamic-scopes,impersonation,scripts
cache=local  # Fix: Use local cache instead of distributed

# Metrics & Health
health-enabled=true
metrics-enabled=true

# Logging (temporarily increase for debugging)
log=console,file
log-console-color=true
log-console-format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%e%n
log-file=/opt/keycloak/log/keycloak.log
log-level=DEBUG

# HTTP
http-relative-path=/auth
http-max-connections=100

# Theme
theme-static-max-age=2592000
theme-cache-themes=true
theme-cache-templates=true

# JWT/Token
spi-token-security-policy-hmac-algorithm=HS512
spi-token-security-policy-hmac-key-size=512

# Sessions
spi-sticky-session-encoder-infinispan-should-attach-route=true
spi-sticky-session-encoder-infinispan-routes-cache-name=routes

# OAuth2/OIDC
oauth2-device-code-lifespan=600
oauth2-device-polling-interval=5